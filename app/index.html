<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Traffic Sensor Analysis</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Bootstrap Table -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/bootstrap-table@1.22.5/dist/bootstrap-table.min.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
      :root {
        --bg-dark: #121212;
        --bg-light: #1e1e1e;
        --text-light: #e0e0e0;
        --text-muted: #999;
        --accent: #0dcaf0;
      }

      body {
        background-color: var(--bg-dark);
        color: var(--text-light);
        font-family: "Segoe UI", sans-serif;
        padding: 2rem;
      }

      h1,
      h2 {
        font-weight: 600;
      }

      .section {
        background-color: var(--bg-light);
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      }

      .form-control,
      .input-group-text {
        background-color: #2a2a2a;
        color: var(--text-light);
        border: 1px solid #444;
      }

      .form-control::placeholder {
        color: var(--text-muted);
      }

      .btn {
        border-radius: 6px;
      }

      .table,
      .table th,
      .table td {
        color: var(--text-light);
        background-color: #202020;
      }

      .table thead {
        background-color: #292929;
      }

      .btn-outline-accent {
        color: var(--accent);
        border-color: var(--accent);
      }

      .btn-outline-accent:hover {
        background-color: var(--accent);
        color: #000;
      }

      canvas {
        background-color: #1a1a1a;
        border-radius: 8px;
        padding: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-5 text-accent text-center">ðŸš¦ Traffic Sensor Analysis</h1>

      <!-- Manual Input Section -->
      <div class="section">
        <h2 class="mb-4">Manual Data Entry</h2>
        <div class="row g-3">
          <div class="col-md-3">
            <div class="input-group">
              <input
                type="number"
                class="form-control"
                id="inputVPM"
                placeholder="VPM"
              />
              <span class="input-group-text">veh/min</span>
            </div>
          </div>
          <div class="col-md-3">
            <div class="input-group">
              <input
                type="number"
                class="form-control"
                id="inputSpeed"
                placeholder="Speed"
              />
              <span class="input-group-text">km/h</span>
            </div>
          </div>
          <div class="col-md-3">
            <div class="input-group">
              <input
                type="number"
                class="form-control"
                id="inputDensity"
                placeholder="Density"
              />
              <span class="input-group-text">veh/km</span>
            </div>
          </div>
          <div class="col-md-3">
            <button class="btn btn-success w-100" onclick="addInput()">
              Add Entry
            </button>
          </div>
        </div>

        <div class="table-responsive mt-4">
          <table class="table table-bordered table-sm" id="inputTable">
            <thead>
              <tr>
                <th>#</th>
                <th>VPM</th>
                <th>Speed</th>
                <th>Density</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="text-end">
          <button class="btn btn-primary mt-2" onclick="evaluateManual()">
            Send to /evaluate
          </button>
        </div>
      </div>

      <!-- Random Sensors Section -->
      <div class="section">
        <h2 class="mb-4">Evaluate with Random Sensors</h2>
        <div class="d-flex align-items-center flex-wrap gap-3">
          <div class="input-group" style="max-width: 200px">
            <input
              type="number"
              class="form-control"
              id="sensors"
              placeholder="e.g. 30"
              min="1"
            />
            <span class="input-group-text">sensors</span>
          </div>
          <button class="btn btn-secondary" onclick="evaluateRandom()">
            Send to /evaluate/{sensors}
          </button>
        </div>
      </div>

      <!-- Results Section -->
      <div class="section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2>Results</h2>
          <button class="btn btn-outline-accent" onclick="exportCSV()">
            â¬‡ Export CSV
          </button>
        </div>
        <div class="table-responsive">
          <table
            id="resultTable"
            class="table"
            data-toggle="table"
            data-pagination="true"
            data-search="true"
          ></table>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="section">
        <h2>ðŸ“Š Charts</h2>
        <canvas id="resultsChart" height="100"></canvas>
      </div>
    </div>

    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap Table -->
    <script src="https://unpkg.com/bootstrap-table@1.22.5/dist/bootstrap-table.min.js"></script>

    <script>
      const manualData = [];
      let latestResults = [];

      function addInput() {
        const vpm = parseFloat(document.getElementById("inputVPM").value);
        const spd = parseFloat(document.getElementById("inputSpeed").value);
        const den = parseFloat(document.getElementById("inputDensity").value);

        if (isNaN(vpm) || isNaN(spd) || isNaN(den)) {
          alert("Please fill in all fields with valid numbers.");
          return;
        }

        manualData.push({ vpm, spd, den });
        updateInputTable();
        document.getElementById("inputVPM").value = "";
        document.getElementById("inputSpeed").value = "";
        document.getElementById("inputDensity").value = "";
      }

      function updateInputTable() {
        const tbody = document.querySelector("#inputTable tbody");
        tbody.innerHTML = "";
        manualData.forEach((item, index) => {
          tbody.innerHTML += `
          <tr>
            <td>${index + 1}</td>
            <td>${item.vpm}</td>
            <td>${item.spd}</td>
            <td>${item.den}</td>
            <td><button class="btn btn-sm btn-danger" onclick="removeInput(${index})">Delete</button></td>
          </tr>`;
        });
      }

      function removeInput(index) {
        manualData.splice(index, 1);
        updateInputTable();
      }

      async function evaluateManual() {
        if (manualData.length === 0) {
          alert("Add at least one entry to evaluate.");
          return;
        }

        const res = await fetch("/evaluate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(manualData),
        });

        const json = await res.json();
        showResults(json.result || json);
      }

      async function evaluateRandom() {
        const sensors = parseInt(document.getElementById("sensors").value);
        if (isNaN(sensors) || sensors <= 0) {
          alert("Enter a valid number of sensors.");
          return;
        }

        const res = await fetch(`/evaluate/${sensors}`, { method: "POST" });
        const json = await res.json();
        showResults(json.result || json);
      }

      function showResults(data) {
        latestResults = data;

        const columns = Object.keys(data[0]).map((key) => ({
          field: key,
          title: key,
          sortable: true,
        }));

        $("#resultTable").bootstrapTable("destroy").bootstrapTable({
          columns,
          data,
        });

        const labels = data.map((_, i) => `Sensor ${i + 1}`);
        const datasets = [
          { label: "VPM", data: data.map((d) => d["VPM"]) },
          { label: "Optimized VPM", data: data.map((d) => d["Optimized VPM"]) },
          { label: "Speed", data: data.map((d) => d["Speed (km/h)"]) },
          {
            label: "Optimized Speed",
            data: data.map((d) => d["Optimized Speed"]),
          },
          { label: "Density", data: data.map((d) => d["Density (veh/km)"]) },
          {
            label: "Optimized Density",
            data: data.map((d) => d["Optimized Density"]),
          },
        ];

        if (window.myChart) window.myChart.destroy();
        const ctx = document.getElementById("resultsChart").getContext("2d");
        window.myChart = new Chart(ctx, {
          type: "bar",
          data: { labels, datasets },
          options: {
            responsive: true,
            plugins: {
              legend: { labels: { color: "#ddd" } },
              title: {
                display: true,
                text: "Original vs Optimized Metrics",
                color: "#fff",
              },
            },
            scales: {
              x: { ticks: { color: "#aaa" } },
              y: { ticks: { color: "#aaa" }, beginAtZero: true },
            },
          },
        });
      }

      function exportCSV() {
        if (!latestResults.length) return alert("No results to export.");

        const keys = Object.keys(latestResults[0]);
        const csv = [
          keys.join(","),
          ...latestResults.map((row) =>
            keys.map((k) => JSON.stringify(row[k] ?? "")).join(",")
          ),
        ].join("\n");

        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "traffic_results.csv";
        a.click();
      }
    </script>
  </body>
</html>
